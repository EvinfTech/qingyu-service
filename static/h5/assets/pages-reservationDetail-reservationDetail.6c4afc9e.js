import{p as e,B as t,v as i,D as s,s as a,J as l,o as c,c as n,w as r,i as o,b as d,n as h,e as u,x as f,F as m,g as p,t as L,r as x,S as _,h as g,j as I}from"./index-0cdf8aad.js";import{r as b,_ as v}from"./uni-app.es.b79b333a.js";import{_ as y}from"./u-navbar.c8086c10.js";import{a as T,f as w}from"./util.4f6eae7a.js";import{r as D}from"./request.4f472fa9.js";import{_ as k}from"./_plugin-vue_export-helper.1b428a4d.js";const j=k({data:()=>({app:e(),active:0,dateList:[],translateDistance:0,tabWidth:0,widthDiff:0,scrollLeft:0,totalPrice:0,choosedList:[],centerHeight:0,timeList:[],siteList:[],todayDeleteIndex:0,con:{already:!1,checked:!1,price:""},j:"",currentDate:"",scrollLeftDistance:0}),onLoad(e){let t=e.date.slice(5);this.currentDate=t},onReady(){this.setAciveDate(this.currentDate),this.$nextTick((()=>{setTimeout((()=>{this.getTabItemWidth()}),500)}))},methods:{getNowTime(){let e=new Date;return[e.getHours(),e.getMinutes()]},initEnumInfo(){let e=this.app.globalData.enumInfo,t=[],i=[];this.dateList[this.active].siteList.forEach((e=>{t=t.concat(e.store_time_enum)})),t=Array.from(new Set(t)),t.sort((function(e,t){return e-t})),t.forEach((t=>{let s=e[t].split("~")[0],a=e[t].split("~")[1],l=i.findIndex((e=>e.value==s)),c=i.findIndex((e=>e.value==a));l<0&&i.push({index:t,value:s}),c<0&&i.push({index:t,value:a})}));let s=0;if(0==this.active){let e=this.getNowTime();s=i.findIndex((t=>{let i=t.value.split(":");if(Number(i[0])>e[0]||Number(i[0])==e[0]&&Number(i[1])>e[1])return!0})),i=-1==s?[]:i.slice(s)}this.timeList=i},deleteItem(e){this.siteList[this.choosedList[e].siteIndex].timeList[this.choosedList[e].siteTimeIndex].checked=!1,this.totalPrice=this.totalPrice-this.choosedList[e].price/100,this.choosedList.splice(e,1)},initData(e){let t=[];0==this.dateList[this.active].isRequest?D({url:"wx/get/site/reserve",method:"POST",data:{date:e}}).then((e=>{e.data.forEach(((e,i)=>{t.push({siteNo:i+1,siteId:e.site_id,disableList:e.reserve_time_enum,siteName:e.site_name,store_time_enum:e.store_time_enum,priceList:e.price,timeList:[]})})),this.dateList[this.active].siteList=t,this.dateList[this.active].isRequest=!0,this.siteList=t,this.initEnumInfo(),this.setTimeList()})):(t=this.dateList[this.active].siteList,this.siteList=t,this.initEnumInfo(),this.setTimeList())},setAciveDate(e){this.dateList=this.et7Days();let t=this.dateList.findIndex((t=>t.date==e));this.active=t},async submitOrder(){if(0==this.choosedList.length)return void t({title:"未选择场地",icon:"none",duration:2e3});let e=await this.app.getUserInfo(),a=[],l=T(this.choosedList,"siteId");for(var c in l){let e=[],t=0,i="";for(var n of l[c])e.push(Number(n.enumInfoIndex)),t+=n.price,i=n.siteName;a.push({site_id:Number(c),time_enum:e,money:t,site_name:i})}i("orderInfo",JSON.stringify({user_ouid:e.ouid,site_detail:a,gmt_site_use:this.choosedList[0].date,site_obj:l,totalPrice:this.totalPrice})),s({url:"/pages/confirmAppointment/confirmAppointment",events:{updateSiteInfo:e=>{e.forEach((e=>{let t=this.siteList.findIndex((t=>t.siteId==e.site_id));e.time_enum.forEach((i=>{let s=this.timeList.findIndex((e=>e.index==i));s=0==s?0:s-1;let a=this.choosedList.findIndex((t=>t.siteId==e.site_id&&t.enumInfoIndex==i));this.siteList[t].timeList[s].already=!0,this.totalPrice=this.totalPrice-this.choosedList[a].price/100,this.siteList[t].timeList[s].price="不可订",this.choosedList.splice(a,1)}))}))}}})},setTimeList(){let e=JSON.parse(JSON.stringify(this.siteList));e.forEach(((e,t)=>{for(var i=1;i<=this.timeList.length-1;i++){let t=e.priceList.findIndex((e=>e.time_enum==this.timeList[i].index));t>=0?e.disableList.includes(this.timeList[i].index)?e.timeList.push({price:e.priceList[t].price,already:!0,checked:!0}):e.timeList.push({price:e.priceList[t].price,already:!1,checked:!1}):e.timeList.push({price:"不可订",already:!0,checked:!1})}})),this.siteList=e},getTabItemWidth(){let e=this;var t=a().windowHeight;l().select(".customerTabItem").boundingClientRect((i=>{l().select(".selected").boundingClientRect((s=>{e.tabWidth=i.width,e.translateDistance=(i.width-s.width)/2,e.widthDiff=(i.width-s.width)/2,e.scrollLeft=i.width*(this.active-4),e.chooseTab(e.active),l().select(".bottomCon").boundingClientRect((s=>{l().select(".nav-bar").boundingClientRect((a=>{e.centerHeight=t-a.height-s.height-i.height})).exec()})).exec()})).exec()})).exec()},chooseTab(e){let t;t=e.hasOwnProperty("currentTarget")?e.currentTarget.dataset.index:e;let i=t*this.tabWidth+this.widthDiff;this.active!=t&&(this.choosedList=[],this.totalPrice=0),this.active=t,this.translateDistance=i,this.initData(this.dateList[t].fullDate)},chooseSite(e){let t=e.currentTarget.dataset;if(!t.item.already&&"不可订"!=t.item.price){if(this.siteList[t.index].timeList[t.j].checked=!this.siteList[t.index].timeList[t.j].checked,this.siteList[t.index].timeList[t.j].checked){let e=this.siteList[t.index],s={siteName:e.siteName,siteId:e.siteId,price:t.item.price,date:this.dateList[this.active].fullDate,startTime:this.timeList[t.j].value,endTime:this.timeList[t.j+1].value,enumInfoIndex:-1,siteIndex:t.index,siteTimeIndex:t.j},a=this.app.globalData.enumInfo;for(var i in a)if(a[i]==s.startTime+"~"+s.endTime){s.enumInfoIndex=i;break}let l=this.choosedList;l.push(s),this.choosedList=l,this.totalPrice=this.totalPrice+s.price/100}else{let e=this.choosedList.findIndex((e=>e.startTime==this.timeList[t.j].value)),i=this.choosedList;i.splice(e,1),this.choosedList=i,this.totalPrice=this.totalPrice-t.item.price/100}this.$nextTick((()=>{this.scrollLeftDistance=9999+this.scrollLeftDistance}))}},et7Days(){let e=[];for(var t=(new Date).getTime(),i=0;i<7;i++){var s=new Date(t+864e5*i),a=s.getFullYear(),l=s.getMonth()+1,c=s.getDate();e.push({fullDate:a+"-"+w(l)+"-"+w(c),date:w(l)+"-"+w(c),day:0==i?"今日":"周"+"日一二三四五六".charAt(s.getDay()),siteList:[],isRequest:!1})}return e}}},[["render",function(e,t,i,s,a,l){const T=b(x("up-icon"),v),w=b(x("u-navbar"),y),D=o,k=_,j=g;return c(),n(D,{class:"page"},{default:r((()=>[d(w,{class:"nav-bar",safeAreaInsetTop:!0,fixed:!1,title:"预约",autoBack:!1},{left:r((()=>[d(T,{name:"arrow-left",onClick:a.app.toBack},null,8,["onClick"])])),_:1}),d(D,{class:"customerTab"},{default:r((()=>[d(k,{"scroll-x":!0,class:"h-full w-full","scroll-left":a.scrollLeft},{default:r((()=>[d(D,{class:"flex align-center w-full h-full",style:{padding:"10rpx 0 0rpx","box-sizing":"border-box",position:"relative"}},{default:r((()=>[d(D,{class:"selected",style:h("transform: translateX("+a.translateDistance+"px);")},null,8,["style"]),(c(!0),u(m,null,f(a.dateList,((e,t)=>(c(),n(D,{class:"customerTabItem h-full","data-index":t,onClick:l.chooseTab,key:t},{default:r((()=>[d(D,{class:"flex flex-direction align-center w-full topItem",style:h("color: "+(t==a.active?"#0077FF":"")+";")},{default:r((()=>[d(D,null,{default:r((()=>[p(L(e.day),1)])),_:2},1024),d(D,{style:{"line-height":"50rpx"}},{default:r((()=>[p(L(e.date),1)])),_:2},1024)])),_:2},1032,["style"])])),_:2},1032,["data-index","onClick"])))),128))])),_:1})])),_:1},8,["scroll-left"])])),_:1}),d(D,{class:"scrollViewBox",style:h("height: "+a.centerHeight+"px;")},{default:r((()=>[d(k,{"scroll-y":!0,"scroll-x":!0,class:"w-full h-full",style:{padding:"10rpx 0 10rpx 0rpx","box-sizing":"border-box"}},{default:r((()=>[d(D,{class:"flex",style:{"margin-left":"10rpx",position:"relative"}},{default:r((()=>[d(D,{class:"leftTimeBox"},{default:r((()=>[(c(!0),u(m,null,f(a.timeList,((e,t)=>(c(),n(D,{class:"timeItem",key:t},{default:r((()=>[p(L(e.value),1)])),_:2},1024)))),128))])),_:1}),d(D,{class:"rightSiteBox",style:{"padding-right":"20rpx"}},{default:r((()=>[d(D,{class:"flex align-center"},{default:r((()=>[(c(!0),u(m,null,f(a.siteList,((e,t)=>(c(),n(D,{class:"siteBox",key:t},{default:r((()=>[p(L(e.siteName)+" ",1),d(D,{style:{"margin-top":"9px"}},{default:r((()=>[(c(!0),u(m,null,f(e.timeList,((e,i)=>(c(),n(D,{"data-item":e,"data-index":t,"data-j":i,onClick:l.chooseSite,key:i},{default:r((()=>[d(D,{class:I(" "+(e.already?"disSelected":e.checked?"selectable":"freeSelect")+" selectItem")},{default:r((()=>[p(L("不可订"==e.price?e.price:" ￥"+e.price/100),1)])),_:2},1032,["class"])])),_:2},1032,["data-item","data-index","data-j","onClick"])))),128))])),_:2},1024)])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1})])),_:1})])),_:1},8,["style"]),d(D,{class:"bottomCon"},{default:r((()=>[d(D,{class:"choosedListBox w-full"},{default:r((()=>[d(k,{"scroll-x":"true",class:"w-full h-full","scroll-left":a.scrollLeftDistance},{default:r((()=>[d(D,{class:"w-full flex align-center"},{default:r((()=>[0==a.choosedList.length?(c(),n(D,{key:0,class:"flex align-center emptyText"},{default:r((()=>[p("暂未选择场地")])),_:1})):(c(),n(D,{key:1,class:"w-full flex align-center"},{default:r((()=>[(c(!0),u(m,null,f(a.choosedList,((e,t)=>(c(),n(D,{class:"choosedItem flex flex-direction",key:t},{default:r((()=>[d(D,{class:"closeBox",onClick:e=>l.deleteItem(t)},{default:r((()=>[d(T,{name:"close",color:"#000",size:"14"})])),_:2},1032,["onClick"]),d(D,{class:"itemTop"},{default:r((()=>[d(j,null,{default:r((()=>[p(L(e.startTime)+"-"+L(e.endTime),1)])),_:2},1024)])),_:2},1024),d(D,{class:"itemBottom flex align-center justify-center"},{default:r((()=>[p(L(e.siteName),1)])),_:2},1024)])),_:2},1024)))),128))])),_:1}))])),_:1})])),_:1},8,["scroll-left"])])),_:1}),d(D,{class:"flex align-center justify-between"},{default:r((()=>[d(D,null,{default:r((()=>[d(j,null,{default:r((()=>[d(j,{class:"rmbBox"},{default:r((()=>[p("￥")])),_:1}),d(j,{class:"priceBox"},{default:r((()=>[p(L(a.totalPrice),1)])),_:1})])),_:1})])),_:1}),d(D,{class:"submitBtn flex align-center justify-center",onClick:l.submitOrder},{default:r((()=>[p("确认预约")])),_:1},8,["onClick"])])),_:1})])),_:1})])),_:1})}],["__scopeId","data-v-6fd20699"]]);export{j as default};
